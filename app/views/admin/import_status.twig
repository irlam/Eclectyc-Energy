{% extends "base.twig" %}

{% block title %}Import Status{% endblock %}

{% block content %}
<section class="card">
    <h2>Import Job Status</h2>

    {% if error %}
        <div class="alert alert-error">
            <p>{{ error }}</p>
        </div>
    {% else %}
        <div class="import-job-status" data-batch-id="{{ job.batch_id }}">
            <dl class="import-summary">
                <div>
                    <dt>Batch ID</dt>
                    <dd><code>{{ job.batch_id }}</code></dd>
                </div>
                <div>
                    <dt>Filename</dt>
                    <dd>{{ job.filename }}</dd>
                </div>
                <div>
                    <dt>Import Type</dt>
                    <dd>{{ job.import_type|upper }}</dd>
                </div>
                <div>
                    <dt>Status</dt>
                    <dd>
                        <span class="badge badge-{{ job.status }}">{{ job.status|upper }}</span>
                        {% if job.dry_run %}
                            <span class="badge badge-info">DRY RUN</span>
                        {% endif %}
                    </dd>
                </div>
                <div>
                    <dt>Queued At</dt>
                    <dd>{{ job.queued_at }}</dd>
                </div>
                {% if job.started_at %}
                <div>
                    <dt>Started At</dt>
                    <dd>{{ job.started_at }}</dd>
                </div>
                {% endif %}
                {% if job.completed_at %}
                <div>
                    <dt>Completed At</dt>
                    <dd>{{ job.completed_at }}</dd>
                </div>
                {% endif %}
                {% if job.user_name %}
                <div>
                    <dt>User</dt>
                    <dd>{{ job.user_name }} ({{ job.user_email }})</dd>
                </div>
                {% endif %}
            </dl>

            {% if job.status in ['processing', 'queued'] %}
                <div class="progress-section mt-3">
                    <h3>Progress</h3>
                    {% if job.total_rows %}
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ job.progress_percent }}%"></div>
                        </div>
                        <p class="progress-text">
                            {{ job.processed_rows }} / {{ job.total_rows }} rows ({{ job.progress_percent }}%)
                        </p>
                    {% else %}
                        <p>Processing... (row count not yet available)</p>
                    {% endif %}
                    
                    <dl class="import-summary mt-2">
                        <div>
                            <dt>Processed</dt>
                            <dd>{{ job.processed_rows }}</dd>
                        </div>
                        <div>
                            <dt>Imported</dt>
                            <dd>{{ job.imported_rows }}</dd>
                        </div>
                        <div>
                            <dt>Failed</dt>
                            <dd>{{ job.failed_rows }}</dd>
                        </div>
                    </dl>
                    
                    <p class="mt-2"><em>This page will auto-refresh every 5 seconds.</em></p>
                </div>
            {% endif %}

            {% if job.status == 'completed' and job.summary %}
                <div class="mt-3">
                    <h3>Summary</h3>
                    <dl class="import-summary">
                        <div>
                            <dt>Rows Processed</dt>
                            <dd>{{ job.processed_rows }}</dd>
                        </div>
                        <div>
                            <dt>Rows Imported</dt>
                            <dd>{{ job.imported_rows }}</dd>
                        </div>
                        <div>
                            <dt>Rows Failed</dt>
                            <dd>{{ job.failed_rows }}</dd>
                        </div>
                        {% if job.summary.meta.total_values_processed %}
                        <div>
                            <dt>Data Points</dt>
                            <dd>{{ job.summary.meta.total_values_processed }}</dd>
                        </div>
                        {% endif %}
                    </dl>

                    {% if job.summary.errors %}
                        <div class="mt-2">
                            <h4>Sample Errors</h4>
                            <ul>
                                {% for error in job.summary.errors|slice(0, 10) %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                </div>
            {% endif %}

            {% if job.status == 'failed' %}
                <div class="alert alert-error mt-3">
                    <h3>Error</h3>
                    <p>{{ job.error_message }}</p>
                </div>
            {% endif %}

            <div class="form-actions mt-3">
                <a href="/admin/imports" class="btn btn-secondary">Back to Imports</a>
                <a href="/admin/imports/jobs" class="btn btn-secondary">View All Jobs</a>
            </div>
        </div>

        {% if job.status in ['processing', 'queued'] %}
        <script>
            // Auto-refresh every 5 seconds for active jobs
            setTimeout(function() {
                window.location.reload();
            }, 5000);
        </script>
        {% endif %}
    {% endif %}
</section>

<style>
.progress-bar {
    width: 100%;
    height: 30px;
    background-color: #e0e0e0;
    border-radius: 5px;
    overflow: hidden;
    margin: 10px 0;
}

.progress-fill {
    height: 100%;
    background-color: #4CAF50;
    transition: width 0.3s ease;
}

.progress-text {
    text-align: center;
    margin: 5px 0;
}

.badge {
    display: inline-block;
    padding: 0.25em 0.6em;
    font-size: 0.875em;
    font-weight: bold;
    line-height: 1;
    color: #fff;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.25rem;
}

.badge-queued { background-color: #6c757d; }
.badge-processing { background-color: #007bff; }
.badge-completed { background-color: #28a745; }
.badge-failed { background-color: #dc3545; }
.badge-cancelled { background-color: #6c757d; }
.badge-info { background-color: #17a2b8; }
</style>
{% endblock %}
