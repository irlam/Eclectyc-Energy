{% extends "base.twig" %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">{{ page_title }}</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="/admin/tariff-switching">Tariff Switching</a></li>
        <li class="breadcrumb-item active">History</li>
    </ol>

    {% if meter %}
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-tachometer-alt me-1"></i>
                Meter Information
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <strong>MPAN:</strong> {{ meter.mpan }}
                    </div>
                    <div class="col-md-3">
                        <strong>Site:</strong> {{ meter.site_name }}
                    </div>
                    <div class="col-md-3">
                        <strong>Type:</strong> {{ meter.meter_type|capitalize }}
                    </div>
                    <div class="col-md-3">
                        <strong>Supplier:</strong> {{ meter.supplier_name ?? 'N/A' }}
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-history me-1"></i>
                Historical Switching Analyses
                <a href="/admin/tariff-switching" class="btn btn-sm btn-primary float-end">
                    <i class="fas fa-plus me-1"></i> New Analysis
                </a>
            </div>
            <div class="card-body">
                {% if analyses is empty %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-1"></i>
                        No historical analyses found for this meter.
                    </div>
                {% else %}
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Analysis Period</th>
                                <th>Current Tariff</th>
                                <th>Current Cost</th>
                                <th>Recommended Tariff</th>
                                <th>Recommended Cost</th>
                                <th>Potential Savings</th>
                                <th>Analyzed By</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for analysis in analyses %}
                                <tr>
                                    <td>{{ analysis.created_at|date('Y-m-d H:i') }}</td>
                                    <td>
                                        {{ analysis.analysis_start_date|date('Y-m-d') }} to 
                                        {{ analysis.analysis_end_date|date('Y-m-d') }}
                                    </td>
                                    <td>{{ analysis.current_tariff_name ?? 'N/A' }}</td>
                                    <td>£{{ analysis.current_cost|number_format(2) }}</td>
                                    <td>{{ analysis.recommended_tariff_name ?? 'N/A' }}</td>
                                    <td>
                                        {% if analysis.recommended_cost > 0 %}
                                            £{{ analysis.recommended_cost|number_format(2) }}
                                        {% else %}
                                            <span class="text-muted">No recommendation</span>
                                        {% endif %}
                                    </td>
                                    <td class="{% if analysis.potential_savings > 0 %}text-success{% endif %}">
                                        {% if analysis.potential_savings > 0 %}
                                            £{{ analysis.potential_savings|number_format(2) }}
                                            ({{ analysis.savings_percent }}%)
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ analysis.analyzed_by_name ?? 'System' }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% endif %}
            </div>
        </div>
    {% else %}
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-1"></i>
            Meter not found.
        </div>
    {% endif %}
</div>
{% endblock %}
