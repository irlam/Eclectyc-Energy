{% extends "base.twig" %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">{{ page_title }}</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
        <li class="breadcrumb-item active">Tariff Switching Analysis</li>
    </ol>

    {% if flash %}
        <div class="alert alert-{{ flash.type == 'error' ? 'danger' : flash.type }} alert-dismissible fade show" role="alert">
            {{ flash.message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endif %}

    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
    {% else %}
        <div class="row">
            <div class="col-xl-12">
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-exchange-alt me-1"></i>
                        Analyze Switching Opportunities
                    </div>
                    <div class="card-body">
                        <form method="POST" action="/admin/tariff-switching/analyze">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="meter_id" class="form-label">Select Meter</label>
                                    <select class="form-select" id="meter_id" name="meter_id" required onchange="updateTariffInfo()">
                                        <option value="">-- Select a meter --</option>
                                        {% for meter in meters %}
                                            <option value="{{ meter.id }}" 
                                                    data-tariff-id="{{ meter.current_tariff_id }}"
                                                    data-tariff-name="{{ meter.current_tariff_name }}"
                                                    {% if selected_meter and selected_meter.id == meter.id %}selected{% endif %}>
                                                {{ meter.mpan }} - {{ meter.site_name }} ({{ meter.meter_type|capitalize }})
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="current_tariff_id" class="form-label">Current Tariff</label>
                                    <input type="hidden" id="current_tariff_id" name="current_tariff_id" value="{{ form_data.current_tariff_id ?? '' }}">
                                    <input type="text" class="form-control" id="current_tariff_display" readonly placeholder="Select a meter first">
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="start_date" class="form-label">Analysis Start Date</label>
                                    <input type="date" class="form-control" id="start_date" name="start_date" 
                                           value="{{ form_data.start_date ?? '' }}" required>
                                    <small class="form-text text-muted">Recommended: 90 days ago</small>
                                </div>
                                <div class="col-md-6">
                                    <label for="end_date" class="form-label">Analysis End Date</label>
                                    <input type="date" class="form-control" id="end_date" name="end_date" 
                                           value="{{ form_data.end_date ?? '' }}" required>
                                    <small class="form-text text-muted">Recommended: Today</small>
                                </div>
                            </div>

                            <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-chart-line me-1"></i> Analyze Tariffs
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="setDefaultDates()">
                                    <i class="fas fa-calendar me-1"></i> Use Last 90 Days
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        {% if analysis %}
            {% if analysis.error %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-1"></i> {{ analysis.error }}
                </div>
            {% else %}
                <!-- Analysis Results -->
                <div class="row">
                    <div class="col-xl-12">
                        <div class="card mb-4">
                            <div class="card-header bg-info text-white">
                                <i class="fas fa-info-circle me-1"></i>
                                Analysis Summary
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <strong>Period Analyzed:</strong><br>
                                        {{ analysis.analysis_period.start_date }} to {{ analysis.analysis_period.end_date }}
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Total Consumption:</strong><br>
                                        {{ analysis.analysis_period.total_consumption|number_format(2) }} kWh
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Days Analyzed:</strong><br>
                                        {{ analysis.analysis_period.days_analyzed }} days
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Current Tariff:</strong><br>
                                        {{ analysis.current.tariff_name }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Current Tariff Cost -->
                <div class="row">
                    <div class="col-xl-4">
                        <div class="card mb-4 border-primary">
                            <div class="card-header bg-primary text-white">
                                <i class="fas fa-file-invoice-dollar me-1"></i>
                                Current Tariff Cost
                            </div>
                            <div class="card-body">
                                <h3 class="text-primary">£{{ analysis.current.total_cost|number_format(2) }}</h3>
                                <hr>
                                <p><strong>Unit Cost:</strong> £{{ analysis.current.unit_cost|number_format(2) }}</p>
                                <p><strong>Standing Charge:</strong> £{{ analysis.current.standing_charge_cost|number_format(2) }}</p>
                                <p class="mb-0"><small class="text-muted">Supplier: {{ analysis.current.supplier_name }}</small></p>
                            </div>
                        </div>
                    </div>

                    {% if analysis.recommendation %}
                        <div class="col-xl-4">
                            <div class="card mb-4 border-success">
                                <div class="card-header bg-success text-white">
                                    <i class="fas fa-thumbs-up me-1"></i>
                                    Recommended Tariff
                                </div>
                                <div class="card-body">
                                    <h5>{{ analysis.recommendation.tariff_name }}</h5>
                                    <h3 class="text-success">£{{ analysis.recommendation.total_cost|number_format(2) }}</h3>
                                    <hr>
                                    <p><strong>Unit Cost:</strong> £{{ analysis.recommendation.unit_cost|number_format(2) }}</p>
                                    <p><strong>Standing Charge:</strong> £{{ analysis.recommendation.standing_charge_cost|number_format(2) }}</p>
                                    <p class="mb-0"><small class="text-muted">Supplier: {{ analysis.recommendation.supplier_name }}</small></p>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-4">
                            <div class="card mb-4 border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <i class="fas fa-piggy-bank me-1"></i>
                                    Potential Savings
                                </div>
                                <div class="card-body">
                                    <h3 class="text-warning">£{{ analysis.recommendation.potential_savings|number_format(2) }}</h3>
                                    <h5 class="text-muted">{{ analysis.recommendation.savings_percent }}%</h5>
                                    <hr>
                                    <p class="mb-0">
                                        By switching from <strong>{{ analysis.current.tariff_name }}</strong> 
                                        to <strong>{{ analysis.recommendation.tariff_name }}</strong>
                                    </p>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="col-xl-8">
                            <div class="card mb-4 border-secondary">
                                <div class="card-header bg-secondary text-white">
                                    <i class="fas fa-info-circle me-1"></i>
                                    No Better Options Found
                                </div>
                                <div class="card-body">
                                    <p>Your current tariff appears to be the most competitive option available.</p>
                                    <p class="mb-0">Review the alternative tariffs below to see detailed comparisons.</p>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <!-- Alternative Tariffs Table -->
                <div class="row">
                    <div class="col-xl-12">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="fas fa-table me-1"></i>
                                Alternative Tariffs Comparison
                            </div>
                            <div class="card-body">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>Tariff Name</th>
                                            <th>Supplier</th>
                                            <th>Type</th>
                                            <th>Unit Rate</th>
                                            <th>Standing Charge</th>
                                            <th>Total Cost</th>
                                            <th>Savings</th>
                                            <th>Savings %</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for alt in analysis.alternatives %}
                                            <tr class="{% if alt.potential_savings > 0 %}table-success{% endif %}">
                                                <td>
                                                    {{ alt.tariff_name }}
                                                    {% if alt.tariff_code %}<br><small class="text-muted">{{ alt.tariff_code }}</small>{% endif %}
                                                </td>
                                                <td>{{ alt.supplier_name }}</td>
                                                <td><span class="badge bg-info">{{ alt.tariff_type|replace({'_': ' '})|title }}</span></td>
                                                <td>{{ alt.unit_rate ? (alt.unit_rate|number_format(4) ~ 'p') : 'N/A' }}</td>
                                                <td>{{ alt.standing_charge ? (alt.standing_charge|number_format(4) ~ 'p/day') : 'N/A' }}</td>
                                                <td><strong>£{{ alt.total_cost|number_format(2) }}</strong></td>
                                                <td class="{% if alt.potential_savings > 0 %}text-success{% elseif alt.potential_savings < 0 %}text-danger{% endif %}">
                                                    £{{ alt.potential_savings|number_format(2) }}
                                                </td>
                                                <td class="{% if alt.savings_percent > 0 %}text-success{% elseif alt.savings_percent < 0 %}text-danger{% endif %}">
                                                    {{ alt.savings_percent }}%
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endif %}
    {% endif %}
</div>

<script>
function updateTariffInfo() {
    const select = document.getElementById('meter_id');
    const option = select.options[select.selectedIndex];
    const tariffId = option.getAttribute('data-tariff-id');
    const tariffName = option.getAttribute('data-tariff-name');
    
    document.getElementById('current_tariff_id').value = tariffId || '';
    document.getElementById('current_tariff_display').value = tariffName || 'No tariff assigned';
}

function setDefaultDates() {
    const today = new Date();
    const ninetyDaysAgo = new Date(today);
    ninetyDaysAgo.setDate(today.getDate() - 90);
    
    document.getElementById('end_date').value = today.toISOString().split('T')[0];
    document.getElementById('start_date').value = ninetyDaysAgo.toISOString().split('T')[0];
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateTariffInfo();
    
    // Set default dates if not already set
    if (!document.getElementById('start_date').value || !document.getElementById('end_date').value) {
        setDefaultDates();
    }
});
</script>
{% endblock %}
