{% extends "base.twig" %}

{% block title %}Import History{% endblock %}

{% block content %}
<section class="card">
    <div class="card-header">
        <div>
            <h2>Import History</h2>
            <p class="mb-2">Review recent ingestion runs captured from the audit log. Use filters to focus on specific batches or outcomes.</p>
        </div>
        <div style="display: flex; gap: 0.5rem;">
            <button type="button" class="btn btn-danger" onclick="deleteAllHistory()" title="Delete all import history">
                Delete All History
            </button>
            <a class="btn btn-tertiary" href="/admin/imports">Back to importer</a>
        </div>
    </div>

    <form method="get" class="filters mb-3">
        <div class="form-group">
            <label for="status">Status</label>
            <select id="status" name="status">
                <option value="">All statuses</option>
                <option value="completed"{% if filters.status == 'completed' %} selected{% endif %}>Completed</option>
                <option value="partial"{% if filters.status == 'partial' %} selected{% endif %}>Partial</option>
                <option value="failed"{% if filters.status == 'failed' %} selected{% endif %}>Failed</option>
                <option value="retrying"{% if filters.status == 'retrying' %} selected{% endif %}>Retrying</option>
                <option value="dry-run"{% if filters.status == 'dry-run' %} selected{% endif %}>Dry run</option>
            </select>
        </div>
        <div class="form-group">
            <label for="type">Type</label>
            <select id="type" name="type">
                <option value="">All types</option>
                <option value="hh"{% if filters.type == 'hh' %} selected{% endif %}>Half-hourly</option>
                <option value="daily"{% if filters.type == 'daily' %} selected{% endif %}>Daily totals</option>
            </select>
        </div>
        <div class="form-group">
            <label for="limit">Limit</label>
            <input id="limit" type="number" name="limit" min="10" max="200" value="{{ filters.limit }}">
        </div>
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Apply</button>
            <button type="button" class="btn btn-danger" onclick="deleteSelected()" id="delete-selected-btn" style="display:none;">
                Delete Selected
            </button>
        </div>
    </form>

    {% if error %}
        <div class="alert alert-danger">
            <p>{{ error }}</p>
        </div>
    {% endif %}

    {% if entries is empty %}
        <p class="muted">No imports found for the current filters.</p>
    {% else %}
        <div class="table-wrapper">
            <table class="table">
                <thead>
                    <tr>
                        <th scope="col">
                            <input type="checkbox" id="select-all" onchange="toggleSelectAll(this)">
                        </th>
                        <th scope="col">Batch</th>
                        <th scope="col">Type</th>
                        <th scope="col">Status</th>
                        <th scope="col">Retry</th>
                        <th scope="col">Records</th>
                        <th scope="col">Duration</th>
                        <th scope="col">Initiated</th>
                        <th scope="col">Operator</th>
                        <th scope="col">Details</th>
                        <th scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in entries %}
                        <tr>
                            <td>
                                <input type="checkbox" class="entry-checkbox" value="{{ entry.id }}" data-batch-id="{{ entry.batch_id }}">
                            </td>
                            <td data-heading="Batch">
                                {{ entry.batch_id }}
                                {% if entry.is_retry %}
                                    <br><small class="muted">Retry of {{ entry.parent_batch_id }}</small>
                                {% endif %}
                                {% if entry.retry_count > 0 %}
                                    <br><small class="muted">Retry #{{ entry.retry_count }}</small>
                                {% endif %}
                            </td>
                            <td data-heading="Type">{{ entry.import_type|upper }}</td>
                            <td data-heading="Status">
                                <span class="status-pill status-{{ entry.status }}">{{ entry.status|replace({'-':' '})|title }}</span>
                            </td>
                            <td data-heading="Retry">
                                {% if entry.status == 'failed' or entry.status == 'partial' %}
                                    <form method="post" action="/admin/imports/retry" style="display:inline;">
                                        <input type="hidden" name="batch_id" value="{{ entry.batch_id }}">
                                        <button type="submit" class="btn btn-sm btn-secondary" title="Retry this import">
                                            Retry
                                        </button>
                                    </form>
                                {% else %}
                                    <span class="muted">â€”</span>
                                {% endif %}
                            </td>
                            <td data-heading="Records">
                                <span class="d-block">{{ entry.imported_records }} imported</span>
                                <span class="d-block muted">{{ entry.failed_records }} failed of {{ entry.total_records }}</span>
                            </td>
                            <td data-heading="Duration">
                                <span class="muted">n/a</span>
                            </td>
                            <td data-heading="Initiated">{{ entry.created_at|date('d M Y H:i') }}</td>
                            <td data-heading="Operator">
                                {% if entry.user_name %}
                                    {{ entry.user_name }}
                                    <br><small class="muted">{{ entry.user_email }}</small>
                                {% else %}
                                    <span class="muted">System</span>
                                {% endif %}
                            </td>
                            <td data-heading="Details">
                                {% set meta = entry.meta %}
                                {% if meta.filename %}
                                    <div><strong>File:</strong> {{ meta.filename }}</div>
                                {% endif %}
                                {% if meta.total_values_processed is defined %}
                                    <div><strong>Values:</strong> {{ meta.total_values_processed }}</div>
                                {% endif %}
                                {% if meta.site_codes %}
                                    <div><strong>Sites:</strong> {{ meta.site_codes|join(', ') }}</div>
                                {% endif %}
                                {% if entry.errors %}
                                    <details>
                                        <summary>{{ entry.errors|length }} errors</summary>
                                        <ul>
                                            {% for error in entry.errors|slice(0, 5) %}
                                                <li>{{ error }}</li>
                                            {% endfor %}
                                            {% if entry.errors|length > 5 %}
                                                <li class="muted">+ {{ entry.errors|length - 5 }} more</li>
                                            {% endif %}
                                        </ul>
                                    </details>
                                {% endif %}
                            </td>
                            <td data-heading="Actions">
                                <button type="button" class="btn btn-sm btn-danger" onclick="deleteEntry({{ entry.id }}, '{{ entry.batch_id }}')" title="Delete this import">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}
</section>

<script>
function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.entry-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
    updateDeleteButton();
}

function updateDeleteButton() {
    const checkboxes = document.querySelectorAll('.entry-checkbox:checked');
    const deleteBtn = document.getElementById('delete-selected-btn');
    if (checkboxes.length > 0) {
        deleteBtn.style.display = 'inline-block';
        deleteBtn.textContent = `Delete Selected (${checkboxes.length})`;
    } else {
        deleteBtn.style.display = 'none';
    }
}

// Add event listener to all checkboxes
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.entry-checkbox');
    checkboxes.forEach(cb => {
        cb.addEventListener('change', updateDeleteButton);
    });
});

function deleteEntry(entryId, batchId) {
    if (!confirm(`Are you sure you want to delete this import record (${batchId})?\n\nThis will remove the audit log entry but will NOT delete the imported data.`)) {
        return;
    }
    
    fetch('/admin/imports/history/' + entryId + '/delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Import history entry deleted successfully.');
            location.reload();
        } else {
            alert('Failed to delete entry: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error deleting entry: ' + error.message);
    });
}

function deleteSelected() {
    const checkboxes = document.querySelectorAll('.entry-checkbox:checked');
    const ids = Array.from(checkboxes).map(cb => cb.value);
    
    if (ids.length === 0) {
        alert('Please select at least one entry to delete.');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete ${ids.length} import record(s)?\n\nThis will remove the audit log entries but will NOT delete the imported data.`)) {
        return;
    }
    
    fetch('/admin/imports/history/delete-bulk', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ ids: ids })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Successfully deleted ${data.deleted} import history entr${data.deleted === 1 ? 'y' : 'ies'}.`);
            location.reload();
        } else {
            alert('Failed to delete entries: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error deleting entries: ' + error.message);
    });
}

function deleteAllHistory() {
    if (!confirm('Are you sure you want to delete ALL import history?\n\nThis will remove all audit log entries but will NOT delete the imported data.\n\nThis action cannot be undone!')) {
        return;
    }
    
    if (!confirm('FINAL WARNING: This will delete ALL import history records. Are you absolutely sure?')) {
        return;
    }
    
    fetch('/admin/imports/history/delete-all', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Successfully deleted ${data.deleted} import history entr${data.deleted === 1 ? 'y' : 'ies'}.`);
            location.reload();
        } else {
            alert('Failed to delete history: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error deleting history: ' + error.message);
    });
}
</script>
{% endblock %}
