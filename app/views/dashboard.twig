{# eclectyc-energy/app/views/dashboard.twig #}
{# Dashboard page template #}
{# Last updated: 06/11/2024 14:45:00 #}

{% extends "base.twig" %}

{% block content %}
<div class="dashboard-header">
    <h2>Energy Management Dashboard</h2>
    <p class="dashboard-subtitle">Real-time insights into your energy portfolio</p>
</div>

<!-- Primary Stats - Horizontal Row -->
<div class="stats-container">
    <div class="stat-card stat-card-primary">
        <div class="stat-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <polyline points="9,22 9,12 15,12 15,22"/>
            </svg>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ stats.total_sites }}</div>
            <div class="stat-label">Total Sites</div>
        </div>
    </div>

    <div class="stat-card stat-card-secondary">
        <div class="stat-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <circle cx="8.5" cy="8.5" r="1.5"/>
                <path d="M21 15l-5-5L5 21"/>
            </svg>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ stats.total_meters }}</div>
            <div class="stat-label">Total Meters</div>
        </div>
    </div>

    <div class="stat-card stat-card-accent">
        <div class="stat-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="22,12 18,12 15,21 9,3 6,12 2,12"/>
            </svg>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ stats.total_readings|number_format }}</div>
            <div class="stat-label">Total Readings</div>
        </div>
    </div>

    <div class="stat-card stat-card-success">
        <div class="stat-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 11l3 3 8-8"/>
                <path d="M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9c1.5 0 2.91.37 4.15 1.02"/>
            </svg>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ stats.coverage_pct }}%</div>
            <div class="stat-label">Data Coverage</div>
            {% if stats.latest_aggregation_date %}
                <div class="stat-meta">Latest: {{ stats.latest_aggregation_date|date("d/m/Y") }}</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Energy Consumption Cards -->
<div class="energy-cards">
    <div class="energy-card energy-card-weekly">
        <div class="energy-header">
            <h3>Week to Date</h3>
            <div class="energy-trend energy-trend-up">+12%</div>
        </div>
        <div class="energy-value">
            {{ stats.week_consumption|number_format(1, '.', ',') }}
            <span class="energy-unit">kWh</span>
        </div>
        <div class="energy-footer">
            <div class="energy-progress">
                <div class="energy-progress-bar" style="width: 65%"></div>
            </div>
        </div>
    </div>

    <div class="energy-card energy-card-monthly">
        <div class="energy-header">
            <h3>Month to Date</h3>
            <div class="energy-trend energy-trend-down">-5%</div>
        </div>
        <div class="energy-value">
            {{ stats.month_consumption|number_format(1, '.', ',') }}
            <span class="energy-unit">kWh</span>
        </div>
        <div class="energy-footer">
            <div class="energy-progress">
                <div class="energy-progress-bar" style="width: 45%"></div>
            </div>
        </div>
    </div>

    <div class="energy-card energy-card-status">
        <div class="energy-header">
            <h3>Last Import</h3>
            <div class="import-status import-status-success"></div>
        </div>
        <div class="energy-value energy-value-small">
            {{ stats.last_import }}
        </div>
        <div class="energy-footer">
            <button class="import-action-btn">View Details</button>
        </div>
    </div>

    {% if carbon_intensity %}
    <div class="energy-card energy-card-carbon">
        <div class="energy-header">
            <h3>Carbon Intensity</h3>
            {% if carbon_intensity.trend == 'rising' %}
                <div class="energy-trend energy-trend-up">Rising</div>
            {% elseif carbon_intensity.trend == 'falling' %}
                <div class="energy-trend energy-trend-down">Falling</div>
            {% else %}
                <div class="energy-trend energy-trend-stable">Stable</div>
            {% endif %}
        </div>
        <div class="energy-value">
            {% if carbon_intensity.current_intensity %}
                {{ carbon_intensity.current_intensity|number_format(0) }}
                <span class="energy-unit">gCO2/kWh</span>
            {% else %}
                <span class="energy-unit-small">No data</span>
            {% endif %}
        </div>
        <div class="energy-footer">
            {% if carbon_intensity.classification %}
                <div class="carbon-level" style="background-color: {{ carbon_intensity.classification.color }}">
                    {{ carbon_intensity.classification.label }}
                </div>
            {% endif %}
            {% if carbon_intensity.last_updated %}
                <div class="energy-meta">Updated: {{ carbon_intensity.last_updated|date("H:i") }}</div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Data Quality Widgets -->
<div class="data-quality-section">
    <h3 class="section-title">ðŸ“Š Data Quality - Actual vs Estimated</h3>
    <div class="data-quality-cards">
        <div class="data-quality-card">
            <div class="data-quality-header">
                <h4>Current Month</h4>
                <span class="data-quality-month">{{ "now"|date("F Y") }}</span>
            </div>
            <div class="data-quality-progress">
                {% set actualPct = data_quality.current_month.actual_pct %}
                <div class="data-quality-bar">
                    <div class="data-quality-bar-actual" style="width: {{ actualPct }}%"></div>
                    <div class="data-quality-bar-estimated" style="width: {{ 100 - actualPct }}%"></div>
                </div>
                <div class="data-quality-legend">
                    <div class="data-quality-legend-item">
                        <span class="data-quality-dot data-quality-dot-actual"></span>
                        <span>Actual: {{ actualPct }}%</span>
                    </div>
                    <div class="data-quality-legend-item">
                        <span class="data-quality-dot data-quality-dot-estimated"></span>
                        <span>Estimated: {{ 100 - actualPct }}%</span>
                    </div>
                </div>
            </div>
            <div class="data-quality-stats">
                <div class="data-quality-stat">
                    <span class="data-quality-stat-label">Total Energy</span>
                    <span class="data-quality-stat-value">{{ data_quality.current_month.total_kwh|number_format(1, '.', ',') }} kWh</span>
                </div>
                <div class="data-quality-stat">
                    <span class="data-quality-stat-label">Actual</span>
                    <span class="data-quality-stat-value">{{ data_quality.current_month.actual_kwh|number_format(1, '.', ',') }} kWh</span>
                </div>
                <div class="data-quality-stat">
                    <span class="data-quality-stat-label">Estimated</span>
                    <span class="data-quality-stat-value">{{ data_quality.current_month.estimated_kwh|number_format(1, '.', ',') }} kWh</span>
                </div>
            </div>
        </div>

        <div class="data-quality-card">
            <div class="data-quality-header">
                <h4>Previous Month</h4>
                <span class="data-quality-month">{{ "first day of last month"|date("F Y") }}</span>
            </div>
            <div class="data-quality-progress">
                {% set actualPct = data_quality.previous_month.actual_pct %}
                <div class="data-quality-bar">
                    <div class="data-quality-bar-actual" style="width: {{ actualPct }}%"></div>
                    <div class="data-quality-bar-estimated" style="width: {{ 100 - actualPct }}%"></div>
                </div>
                <div class="data-quality-legend">
                    <div class="data-quality-legend-item">
                        <span class="data-quality-dot data-quality-dot-actual"></span>
                        <span>Actual: {{ actualPct }}%</span>
                    </div>
                    <div class="data-quality-legend-item">
                        <span class="data-quality-dot data-quality-dot-estimated"></span>
                        <span>Estimated: {{ 100 - actualPct }}%</span>
                    </div>
                </div>
            </div>
            <div class="data-quality-stats">
                <div class="data-quality-stat">
                    <span class="data-quality-stat-label">Total Energy</span>
                    <span class="data-quality-stat-value">{{ data_quality.previous_month.total_kwh|number_format(1, '.', ',') }} kWh</span>
                </div>
                <div class="data-quality-stat">
                    <span class="data-quality-stat-label">Actual</span>
                    <span class="data-quality-stat-value">{{ data_quality.previous_month.actual_kwh|number_format(1, '.', ',') }} kWh</span>
                </div>
                <div class="data-quality-stat">
                    <span class="data-quality-stat-label">Estimated</span>
                    <span class="data-quality-stat-value">{{ data_quality.previous_month.estimated_kwh|number_format(1, '.', ',') }} kWh</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modern Action Cards -->
<div class="action-cards">
    <div class="action-card action-card-primary">
        <div class="action-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <polyline points="9,22 9,12 15,12 15,22"/>
            </svg>
        </div>
        <div class="action-content">
            <h3>Manage Sites</h3>
            <p>Configure and monitor your energy sites</p>
        </div>
        <a href="/admin/sites" class="action-link"></a>
    </div>

    <div class="action-card action-card-secondary">
        <div class="action-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="20" x2="18" y2="10"/>
                <line x1="12" y1="20" x2="12" y2="4"/>
                <line x1="6" y1="20" x2="6" y2="14"/>
            </svg>
        </div>
        <div class="action-content">
            <h3>View Reports</h3>
            <p>Analyze consumption and cost data</p>
        </div>
        <a href="/reports/consumption" class="action-link"></a>
    </div>

    <div class="action-card action-card-accent">
        <div class="action-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
            </svg>
        </div>
        <div class="action-content">
            <h3>System Health</h3>
            <p>Monitor API and system status</p>
        </div>
        <a href="/api/health" class="action-link" target="_blank"></a>
    </div>

    <div class="action-card action-card-tertiary">
        <div class="action-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9,11 12,14 22,4"/>
                <path d="M21,12c0,4.97-4.03,9-9,9s-9-4.03-9-9 4.03-9,9-9c1.5,0 2.91,.37 4.15,1.02"/>
            </svg>
        </div>
        <div class="action-content">
            <h3>System Check</h3>
            <p>Validate system configuration</p>
        </div>
        <a href="/tools/check" class="action-link"></a>
    </div>
</div>

<!-- Data Overview -->
<div class="overview-section">
    <div class="overview-card">
        <div class="overview-header">
            <h2>Recent Activity</h2>
            <div class="overview-badge">Live</div>
        </div>
        {% if recent_activity is not empty %}
            <div class="activity-list">
                {% for item in recent_activity|slice(0, 5) %}
                    <div class="activity-item">
                        <div class="activity-icon">
                            <div class="activity-dot"></div>
                        </div>
                        <div class="activity-content">
                            <div class="activity-text">{{ item.action }} - {{ item.entity_type ?: 'system' }}</div>
                            <div class="activity-time">{{ item.created_at|date("H:i") }} â€¢ {{ item.created_at|date("d/m/Y") }}</div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            {% if recent_activity|length > 5 %}
                <div class="overview-footer">
                    <a href="/admin/imports/history" class="view-all-link">View all activity â†’</a>
                </div>
            {% endif %}
        {% else %}
            <div class="empty-state">
                <p>No recent activity to display</p>
            </div>
        {% endif %}
    </div>

    <div class="overview-card">
        <div class="overview-header">
            <h2>Consumption Trend</h2>
            <div class="trend-period">Last 7 days</div>
        </div>
        {% if trend is not empty %}
            <div class="trend-chart">
                {% set max_total = 0 %}
                {% for point in trend %}
                    {% if point.total > max_total %}
                        {% set max_total = point.total %}
                    {% endif %}
                {% endfor %}
                {% for point in trend %}
                    <div class="trend-item">
                        <div class="trend-bar">
                            {% set height_percent = max_total > 0 ? ((point.total / max_total) * 100)|round : 0 %}
                            <div class="trend-bar-fill" style="height: {{ height_percent }}%"></div>
                        </div>
                        <div class="trend-label">{{ point.date|date("d/m") }}</div>
                    </div>
                {% endfor %}
            </div>
            <div class="trend-summary">
                {% set total_consumption = 0 %}
                {% for point in trend %}
                    {% set total_consumption = total_consumption + point.total %}
                {% endfor %}
                <div class="trend-total">
                    Total: {{ total_consumption|number_format(1, '.', ',') }} kWh
                </div>
            </div>
        {% else %}
            <div class="empty-state">
                <p>No consumption data available</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Dashboard-specific JavaScript
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard loaded with trend data:', {{ trend|json_encode|raw }});
});
</script>
{% endblock %}